<div class="my-scans">
  <!-- Header Section -->
  <div class="scans-header">
    <div class="header-content">
      <h1 class="scans-title">Mis Escaneos</h1>
      <p class="scans-subtitle">Historial de escaneos realizados y sus resultados</p>
    </div>
    <div class="controls-right">
      <button class="btn--primary" (click)="goToNewScan()">
        <span class="btn-icon">+</span>
        Nuevo Escaneo
      </button>
    </div>
  </div>

  <!-- Controls Section -->
  <div class="scans-controls">
    <div class="search-section">
      <div class="search-input-wrapper">
        <fa-icon [icon]="faSearch" class="search-icon"></fa-icon>
        <input 
          type="text" 
          placeholder="Buscar por alias o URL..." 
          class="search-input"
          [(ngModel)]="searchTerm"
          (input)="searchScans()"
        >
        <button 
          *ngIf="searchTerm" 
          class="search-clear"
          (click)="clearSearch()"
          type="button"
        >
          <fa-icon [icon]="faTimes"></fa-icon>
        </button>
      </div>
    </div>

    <div class="filters-left">
      <div class="filter-group">
        <button 
          class="filter-btn"
          (click)="openStatusModal()"
          type="button"
        >
          <span class="filter-label">
            {{ getStatusFilterLabel() }}
          </span>
          <fa-icon [icon]="faChevronDown" class="filter-icon"></fa-icon>
        </button>
      </div>

      <div class="filter-group">
        <button 
          class="filter-btn"
          (click)="openTypeModal()"
          type="button"
        >
          <span class="filter-label">
            {{ getTypeFilterLabel() }}
          </span>
          <fa-icon [icon]="faChevronDown" class="filter-icon"></fa-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="filters-section">
    <!-- Results Count -->
    <div class="results-count">
      {{ filteredScans.length }} escaneos encontrados
    </div>
    
    <div class="filters-right">
      <div class="view-toggle">
        <button 
          class="toggle-btn" 
          [class.active]="viewMode === 'grid'"
          (click)="setViewMode('grid')"
          [attr.aria-label]="'Vista de cuadrícula'"
        >
          <fa-icon [icon]="faTh"></fa-icon>
        </button>
        <button 
          class="toggle-btn" 
          [class.active]="viewMode === 'list'"
          (click)="setViewMode('list')"
          [attr.aria-label]="'Vista de lista'"
        >
          <fa-icon [icon]="faList"></fa-icon>
        </button>
      </div>
    </div>

  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-state">
    <div class="loading-spinner"></div>
    <p>Cargando escaneos...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-state">
    <div class="error-icon"><fa-icon [icon]="faExclamationTriangle"></fa-icon></div>
    <p>{{ error }}</p>
    <button class="btn--primary" (click)="loadScans()">
      Reintentar
    </button>
  </div>

  <!-- Scans List -->
  <div *ngIf="!loading && !error" class="scans-container">
    <!-- List View -->
    <div *ngIf="viewMode === 'list'" class="scans-list">
      <div class="list-header">
        <div class="header-cell alias-url">Alias / URL</div>
        <div class="header-cell fecha">Fecha</div>
        <div class="header-cell estado">Estado</div>
        <div class="header-cell vulnerabilidades">Vulnerabilidades</div>
        <div class="header-cell acciones">Acciones</div>
      </div>

      <div class="list-body">
        <div 
          *ngFor="let scan of filteredScans" 
          class="scan-row"
        >
          <div class="scan-cell alias-url">
            <div class="scan-alias">{{ scan.alias }}</div>
            <div class="scan-url">{{ scan.url }}</div>
          </div>

          <div class="scan-cell fecha">
            {{ formatDate(scan.fecha_inicio) }}
          </div>

          <div class="scan-cell estado">
            <div class="status-indicator" [class]="getStatusClass(scan.estado)">
              <span class="status-icon">{{ getStatusIcon(scan.estado) }}</span>
              <span class="status-label">{{ getStatusLabel(scan.estado) }}</span>
            </div>
          </div>

          <div class="scan-cell vulnerabilidades">
            <div *ngIf="scan.vulnerabilidades.count > 0" class="vulnerability-info">
              <span class="vuln-count">{{ scan.vulnerabilidades.count }}</span>
              <div class="vuln-tags">
                <span 
                  *ngFor="let type of scan.vulnerabilidades.types" 
                  class="vuln-tag"
                >
                  {{ type }}
                </span>
              </div>
            </div>
            <span *ngIf="scan.vulnerabilidades.count === 0" class="no-vulns">-</span>
          </div>

          <div class="scan-cell acciones">
            <div class="actions-container">
              <button 
                class="actions-btn"
                (click)="toggleActionsMenu(scan._id); $event.stopPropagation()"
                [attr.aria-label]="'Menú de acciones'"
                type="button"
              >
                <fa-icon [icon]="faEllipsisVertical"></fa-icon>
              </button>
              
              <div 
                *ngIf="showActionsMenu === scan._id" 
                class="actions-menu"
                (click)="$event.stopPropagation()"
              >
                <button 
                  class="action-item"
                  (click)="viewReport(scan); closeActionsMenu()"
                  *ngIf="scan.estado === 'finalizado'"
                >
                  <fa-icon [icon]="faChartBar"></fa-icon>
                  Ver reporte completo
                </button>
                <button 
                  class="action-item"
                  (click)="viewDetails(scan); closeActionsMenu()"
                >
                  <fa-icon [icon]="faEye"></fa-icon>
                  Ver detalles
                </button>
                <button 
                  class="action-item"
                  (click)="visitSite(scan.url); closeActionsMenu()"
                >
                  <fa-icon [icon]="faLink"></fa-icon>
                  Visitar sitio
                </button>
                <button 
                  class="action-item danger"
                  (click)="deleteScan(scan); closeActionsMenu()"
                >
                  <fa-icon [icon]="faTrash"></fa-icon>
                  Eliminar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Grid View -->
    <div *ngIf="viewMode === 'grid'" class="scans-grid">
      <div 
        *ngFor="let scan of filteredScans" 
        class="scan-card"
      >
        <div class="card-header">
          <h3 class="card-title">{{ scan.alias }}</h3>
          <div class="card-status" [class]="getStatusClass(scan.estado)">
            {{ getStatusLabel(scan.estado) }}
          </div>
        </div>
        
        <div class="card-body">
          <div class="scan-url">{{ scan.url }}</div>
          <div class="scan-date">{{ formatDate(scan.fecha_inicio) }}</div>
          
          <div class="scan-vulnerabilities">
            <div *ngIf="scan.vulnerabilidades.count > 0" class="vuln-info">
              <span class="vuln-count">{{ scan.vulnerabilidades.count }} vulnerabilidades</span>
              <div class="vuln-tags">
                <span 
                  *ngFor="let type of scan.vulnerabilidades.types" 
                  class="vuln-tag"
                >
                  {{ type }}
                </span>
              </div>
            </div>
            <div *ngIf="scan.vulnerabilidades.count === 0" class="no-vulns">
              Sin vulnerabilidades
            </div>
          </div>
        </div>

        <div class="card-actions">
          <button class="btn btn--primary" (click)="viewReport(scan)" *ngIf="scan.estado === 'finalizado'">
            Ver reporte
          </button>
          <button class="btn btn--outline" (click)="viewDetails(scan)">
            Ver detalles
          </button>
          <button class="btn btn--outline" (click)="visitSite(scan.url)">
            Visitar sitio
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading && !error && filteredScans.length === 0" class="empty-state">
    <div class="empty-icon"><fa-icon [icon]="faChartBar"></fa-icon></div>
    <h3>No hay escaneos</h3>
    <p>No se encontraron escaneos que coincidan con los filtros aplicados.</p>
    <button class="btn--primary" (click)="goToNewScan()">
      Crear primer escaneo
    </button>
  </div>

  <!-- Status Filter Modal -->
  <div class="modal-overlay" *ngIf="showStatusModal" (click)="closeStatusModal()">
    <div class="filter-modal" (click)="$event.stopPropagation()">
      <div class="filter-modal-header">
        <h3>Filtrar por Estado</h3>
        <button class="modal-close" (click)="closeStatusModal()" type="button">
          <fa-icon [icon]="faTimes"></fa-icon>
        </button>
      </div>
      <div class="filter-modal-body">
        <button
          *ngFor="let option of statusOptions"
          class="filter-option"
          [class.active]="statusFilter === option.value"
          (click)="selectStatusFilter(option.value)"
          type="button"
        >
          <span class="option-label">{{ option.label }}</span>
          <fa-icon *ngIf="statusFilter === option.value" [icon]="faCheck" class="check-icon"></fa-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Type Filter Modal -->
  <div class="modal-overlay" *ngIf="showTypeModal" (click)="closeTypeModal()">
    <div class="filter-modal" (click)="$event.stopPropagation()">
      <div class="filter-modal-header">
        <h3>Filtrar por Tipo</h3>
        <button class="modal-close" (click)="closeTypeModal()" type="button">
          <fa-icon [icon]="faTimes"></fa-icon>
        </button>
      </div>
      <div class="filter-modal-body">
        <button
          *ngFor="let option of typeOptions"
          class="filter-option"
          [class.active]="typeFilter === option.value"
          (click)="selectTypeFilter(option.value)"
          type="button"
        >
          <span class="option-label">{{ option.label }}</span>
          <fa-icon *ngIf="typeFilter === option.value" [icon]="faCheck" class="check-icon"></fa-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- Scan Details Modal -->
  <div class="modal-overlay" *ngIf="showDetailsModal" (click)="closeDetailsModal()">
    <div class="modal-content scan-details-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Detalles del Escaneo</h3>
        <button class="modal-close" (click)="closeDetailsModal()">&times;</button>
      </div>

      <div class="modal-body">
        <div *ngIf="loadingDetails" class="loading-details">
          <div class="loading-spinner"></div>
          <p>Cargando detalles...</p>
        </div>

        <div *ngIf="selectedScan && !loadingDetails" class="scan-details">
          <!-- Scan Info -->
          <div class="detail-section">
            <h4>Información del Escaneo</h4>
            <div class="detail-grid">
              <div class="detail-item">
                <label>Alias:</label>
                <span>{{ selectedScan.alias }}</span>
              </div>
              <div class="detail-item">
                <label>URL:</label>
                <span>{{ selectedScan.url }}</span>
              </div>
              <div class="detail-item">
                <label>Estado:</label>
                <span [class]="getStatusClass(selectedScan.estado)">
                  {{ getStatusLabel(selectedScan.estado) }}
                </span>
              </div>
              <div class="detail-item">
                <label>Fecha de inicio:</label>
                <span>{{ formatDate(selectedScan.fecha_inicio) }}</span>
              </div>
              <div class="detail-item" *ngIf="selectedScan.fecha_fin">
                <label>Fecha de finalización:</label>
                <span>{{ formatDate(selectedScan.fecha_fin) }}</span>
              </div>
            </div>
          </div>

          <!-- Vulnerabilities -->
          <div class="detail-section" *ngIf="selectedScan.vulnerabilidades.length > 0">
            <h4>Vulnerabilidades Detectadas ({{ selectedScan.vulnerabilidades.length }})</h4>
            <div class="vulnerabilities-list">
              <div 
                *ngFor="let vuln of selectedScan.vulnerabilidades" 
                class="vulnerability-item"
                [class]="getSeverityClass(vuln.nivel_severidad_id.nombre)"
              >
                <div class="vuln-header">
                  <span class="vuln-type">{{ vuln.tipo_id.nombre }}</span>
                  <span class="vuln-severity">{{ getSeverityLabel(vuln.nivel_severidad_id.nombre) }}</span>
                </div>
                <div class="vuln-content">
                  <p *ngIf="vuln.descripcion"><strong>Descripción:</strong> {{ vuln.descripcion }}</p>
                  <p *ngIf="vuln.parametro_afectado"><strong>Parámetro afectado:</strong> {{ vuln.parametro_afectado }}</p>
                  <p *ngIf="vuln.url_afectada"><strong>URL afectada:</strong> {{ vuln.url_afectada }}</p>
                  <p *ngIf="vuln.sugerencia"><strong>Sugerencia:</strong> {{ vuln.sugerencia }}</p>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="selectedScan.vulnerabilidades.length === 0" class="no-vulnerabilities">
            <p>No se detectaron vulnerabilidades en este escaneo.</p>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn btn--outline" (click)="closeDetailsModal()">
          Cerrar
        </button>
        <button 
          class="btn--primary" 
          (click)="visitSite(selectedScan.url); closeDetailsModal()"
          *ngIf="selectedScan"
        >
          Visitar sitio
        </button>
      </div>
    </div>
  </div>
</div>
