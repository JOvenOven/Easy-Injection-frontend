<div class="vulnerability-details-container" *ngIf="!loading && vulnerability">
  <!-- Header -->
  <header class="details-header">    
    <div class="header-content">
      <button class="back-button" (click)="goBack()">
        <span>←</span> Volver a Resultados
      </button>
      <h1>Reporte de Vulnerabilidades</h1>
      <p class="scan-info">
        {{ vulnerability.scan?.alias }} - {{ vulnerability.scan?.url }}
      </p>
    </div>
  </header>

  <!-- Vulnerability Title and Severity -->
  <div class="vulnerability-title-section">
    <h2>{{ vulnerability.tipo_id.nombre || 'Vulnerabilidad' }} en parámetro {{ vulnerability.parametro_afectado || 'query' }}</h2>
    
    <div class="badges">
      <span 
        class="severity-badge" 
        [ngClass]="getSeverityClass(vulnerability.nivel_severidad_id.nombre)">
        Severidad: {{ getSeverityLabel(vulnerability.nivel_severidad_id.nombre) }}
      </span>
      <span class="subtitle-badge">
        Subtipo: {{ vulnerability.tipo_id.descripcion || 'Consulta de UNION' }}
      </span>
    </div>
  </div>

  <!-- Main Content -->
  <div class="details-content">
    <!-- Details Card -->
    <section class="details-card">
      <h3>Detalles de la vulnerabilidad:</h3>
      
      <div class="detail-grid">
        <div class="detail-row">
          <span class="detail-label">URL:</span>
          <span class="detail-value">{{ vulnerability.url_afectada || vulnerability.scan?.url }}</span>
        </div>
        
        <div class="detail-row">
          <span class="detail-label">Parámetro vulnerable:</span>
          <span class="detail-value">{{ vulnerability.parametro_afectado || 'query' }}</span>
        </div>
        
        <div class="detail-row">
          <span class="detail-label">Tipo de vulnerabilidad:</span>
          <span class="detail-value">{{ vulnerability.tipo_id.nombre }}</span>
        </div>
        
        <div class="detail-row">
          <span class="detail-label">Subtipo de vulnerabilidad:</span>
          <span class="detail-value">{{ vulnerability.tipo_id.descripcion || 'Consulta de UNION' }}</span>
        </div>
        
        <div class="detail-row">
          <span class="detail-label">Severidad:</span>
          <span class="detail-value" [ngClass]="getSeverityClass(vulnerability.nivel_severidad_id.nombre)">
            {{ getSeverityLabel(vulnerability.nivel_severidad_id.nombre) }}
          </span>
        </div>
      </div>

      <!-- Description Section -->
      <div class="description-section">
        <h4>Descripción del problema:</h4>
        <p>{{ vulnerability.descripcion || 'Se ha detectado una vulnerabilidad en el parámetro ' + (vulnerability.parametro_afectado || 'query') + ' de la URL. La aplicación no valida ni sanitiza adecuadamente la entrada del usuario antes de incluirla en una consulta SQL.' }}</p>
        
        <p *ngIf="vulnerability.tipo_id.nombre.toLowerCase().includes('sql')">
          La vulnerabilidad fue confirmada utilizando la técnica UNION SELECT, que permitió extraer información de otras tablas de la base de datos. Se pudo determinar que la base de datos es MySQL 5.7 y se logró extraer nombres de tablas del esquema de información.
        </p>
      </div>

      <!-- Mitigation Section -->
      <div class="mitigation-section">
        <h4>Sugerencias de mitigación:</h4>
        <ol class="mitigation-list">
          <li *ngFor="let step of mitigationSteps; let i = index">
            {{ step }}
          </li>
        </ol>
      </div>

      <!-- References Section -->
      <div class="references-section">
        <h4>Referencias:</h4>
        <ul class="reference-list">
          <li *ngIf="vulnerability.referencia">
            <a [href]="vulnerability.referencia" target="_blank" rel="noopener noreferrer">
              {{ vulnerability.referencia }}
            </a>
          </li>
          <li *ngIf="vulnerability.tipo_id.nombre.toLowerCase().includes('sql')">
            <a href="https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html" target="_blank" rel="noopener noreferrer">
              https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html
            </a>
          </li>
          <li *ngIf="vulnerability.tipo_id?.nombre?.toLowerCase() === 'xss'">
            <a href="https://owasp.org/www-community/attacks/xss/" target="_blank" rel="noopener noreferrer">
              https://owasp.org/www-community/attacks/xss/
            </a>
          </li>
          <li>
            <a href="https://portswigger.net/web-security/{{ vulnerability.tipo_id.nombre.toLowerCase() || 'sql-injection' }}" target="_blank" rel="noopener noreferrer">
              https://portswigger.net/web-security/{{ vulnerability.tipo_id.nombre.toLowerCase() || 'sql-injection' }}
            </a>
          </li>
        </ul>
      </div>

      <!-- Security Notice -->
      <div class="security-notice">
        <span class="notice-icon">ℹ️</span>
        <div class="notice-content">
          <strong>Información de seguridad</strong>
          <p>Este reporte contiene información sensible sobre vulnerabilidades de seguridad. Por favor, maneja esta información con responsabilidad y sigue las recomendaciones de mitigación lo antes posible.</p>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- Loading State -->
<div class="loading-container" *ngIf="loading">
  <div class="spinner"></div>
  <p>Cargando detalles de la vulnerabilidad...</p>
</div>

<!-- Error State -->
<div class="error-container" *ngIf="error && !loading">
  <div class="error-icon">⚠️</div>
  <h2>Error</h2>
  <p>{{ error }}</p>
  <button class="btn-primary" (click)="goBack()">Volver al reporte</button>
</div>
