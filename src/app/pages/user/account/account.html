<div class="account">
    <h1 class="account-title">Mi cuenta</h1>
    <p class="account-subtitle">
      Gestiona tu informaci√≥n de cuenta y preferencias de seguridad
    </p>

    <!-- Notification Display -->
    <div *ngIf="showNotification" 
         class="notification" 
         [ngClass]="notificationType === 'error' ? 'submit-error' : 'submit-success'">
      <span>{{ notificationMessage }}</span>
      <button class="notification-close" (click)="hideNotification()">&times;</button>
    </div>
  
    <div class="account-container">
      <!-- Men√∫ lateral -->
      <aside class="account-sidebar">
        <ul>
          <li [class.active]="activeTab === 'info'" (click)="scrollToSection('perfil')">
            <fa-icon [icon]="faUser"></fa-icon> Informaci√≥n
          </li>
          <li [class.active]="activeTab === 'security'" (click)="navigateToSecurity()">
            <fa-icon [icon]="faLock"></fa-icon> Seguridad
          </li>
          <li (click)="downloadHelp()">
            <fa-icon [icon]="faQuestionCircle"></fa-icon> Ayuda
          </li>
        </ul>
        <button class="btn-logout" (click)="logout()">Cerrar sesi√≥n</button>
      </aside>
  
      <!-- Panel principal -->
      <div class="account-content">
        <!-- Informaci√≥n personal -->
        <div class="card" id="perfil" *ngIf="activeTab === 'info'">
          <div class="card-header">
            <h3>Perfil</h3>
            <button class="btn-outline" (click)="openEditProfileModal()">Editar perfil</button>
          </div>
          <div class="profile-info">
            <img [src]="getAvatarPath(user.perfil?.avatarId || 'avatar1')" alt="Avatar" class="avatar" />
            <div>
              <p><strong>Nombre de usuario:</strong> {{ user.username }}</p>
              <p><strong>Correo electr√≥nico:</strong> {{ user.email }}</p>
              <p><strong>√öltimo inicio de sesi√≥n:</strong> {{ formatDateTime(user.ultimo_login) }}</p>
              <p><strong>Cuenta creada el:</strong> {{ formatDate(user.fecha_registro) }}</p>
            </div>
          </div>
        </div>


        <!-- Sesiones activas -->
        <div class="card" *ngIf="activeTab === 'info'">
          <div class="card-header">
            <h3>Sesiones activas</h3>
            <button class="btn-outline" (click)="closeAllSessions()" *ngIf="sessions.length > 1">
              Cerrar todas
            </button>
          </div>
          <p class="text-muted">Dispositivos donde tu cuenta est√° actualmente iniciada</p>
          
          <div class="sessions-list" *ngIf="sessions.length > 0">
            <div class="session-item" *ngFor="let session of sessions">
              <div class="session-icon">
                <fa-icon [icon]="getDeviceIcon(session.device)"></fa-icon>
              </div>
              <div class="session-info">
                <div class="session-header">
                  <strong>{{ session.device || 'Dispositivo desconocido' }}</strong>
                  <span class="current-badge" *ngIf="isCurrentSession(session)">Activo ahora</span>
                </div>
                <div class="session-details">
                  <span><fa-icon [icon]="getBrowserIcon(session.browser)"></fa-icon> {{ session.browser || 'Navegador desconocido' }}</span>
                  <span class="separator">‚Ä¢</span>
                  <span><fa-icon [icon]="faMapMarkerAlt"></fa-icon> {{ session.location || 'Ubicaci√≥n desconocida' }}</span>
                </div>
                <div class="session-meta">
                  <span>{{ formatLastActivity(session.lastActivity) }}</span>
                </div>
              </div>
                <button 
                class="btn-close-session" 
                (click)="closeSession(session._id)"
                [title]="isCurrentSession(session) ? 'Cerrar sesi√≥n (desconectar)' : 'Cerrar sesi√≥n'">
                <fa-icon [icon]="faTimes"></fa-icon>
              </button>
            </div>
          </div>

          <div class="sessions-actions" *ngIf="sessions.length > 0">
            <button class="btn-danger-outline" (click)="closeAllSessionsAndLogout()">
              Cerrar todas las sesiones
            </button>
          </div>

          <div class="empty-sessions" *ngIf="sessions.length === 0">
            <p>No hay sesiones activas</p>
          </div>
        </div>

        <!-- Seguridad -->
        <div class="card" id="seguridad" *ngIf="activeTab === 'security'">
          <div class="card-header">
            <h3>Seguridad</h3>
          </div>
          <p class="text-muted">Gestiona tu contrase√±a y autenticaci√≥n de dos factores</p>

          <!-- Change Password Section -->
          <div class="security-section">
            <div class="security-item">
              <div class="security-icon">
                <fa-icon [icon]="faLock"></fa-icon>
              </div>
              <div class="security-info">
                <h4>Contrase√±a</h4>
                <p>Cambia tu contrase√±a regularmente para mayor seguridad</p>
              </div>
              <button class="btn-outline" (click)="openChangePasswordModal()">
                Cambiar contrase√±a
              </button>
            </div>
          </div>
        </div>

        <!-- Eliminar cuenta -->
        <div class="card danger-zone" *ngIf="activeTab === 'info'">
          <div class="card-header">
            <h3>Eliminar cuenta</h3>
          </div>
          <p class="text-muted">
            Una vez que elimines tu cuenta, no hay vuelta atr√°s. Por favor, aseg√∫rate de que realmente deseas hacer esto.
          </p>
          <button type="button" class="btn-danger" (click)="openDeleteAccountModal()">
            Eliminar mi cuenta
          </button>
        </div>
      </div>
    </div>

    <!-- Password Change Modal -->
    <div class="modal-overlay" *ngIf="showPasswordModal" (click)="closeChangePasswordModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Cambiar contrase√±a</h3>
          <button class="modal-close" (click)="closeChangePasswordModal()">&times;</button>
        </div>
        
        <div class="modal-body">
          <p class="modal-description">
            Crea una nueva contrase√±a segura que no uses en otros sitios
          </p>

          <!-- Password Change Notification -->
          <div *ngIf="showChangePasswordMessage" 
               class="modal-notification" 
               [ngClass]="changePasswordMessageType === 'error' ? 'submit-error' : 'submit-success'">
            <span>{{ changePasswordMessage }}</span>
            <button class="notification-close" (click)="hideChangePasswordNotification()">&times;</button>
          </div>
          
          <form [formGroup]="changePasswordForm" (ngSubmit)="changePassword()">
            <div class="form-group">
              <label for="currentPassword">Contrase√±a actual</label>
              <div class="password-input">
                <input 
                  [type]="showCurrentPassword ? 'text' : 'password'" 
                  id="currentPassword"
                  formControlName="currentPassword"
                  placeholder="Ingresa tu contrase√±a actual"
                >
                <!-- <button type="button" class="password-toggle" (click)="togglePasswordVisibility('current')">
                  {{ showCurrentPassword ? 'üôà' : 'üëÅÔ∏è' }}
                </button> -->
              </div>
              <div class="error-message" *ngIf="changePasswordForm.get('currentPassword')?.invalid && changePasswordForm.get('currentPassword')?.touched">
                La contrase√±a actual es requerida
              </div>
            </div>

            <div class="form-group">
              <label for="newPassword">Nueva contrase√±a</label>
              <div class="password-input">
                <input 
                  [type]="showNewPassword ? 'text' : 'password'" 
                  id="newPassword"
                  formControlName="newPassword"
                  placeholder="Ingresa tu nueva contrase√±a"
                >
                <!-- <button type="button" class="password-toggle" (click)="togglePasswordVisibility('new')">
                  {{ showNewPassword ? 'üôà' : 'üëÅÔ∏è' }}
                </button> -->
              </div>
              <div class="error-message" *ngIf="changePasswordForm.get('newPassword')?.invalid && changePasswordForm.get('newPassword')?.touched">
                <div *ngIf="changePasswordForm.get('newPassword')?.errors?.['required']">La nueva contrase√±a es requerida</div>
                <div *ngIf="changePasswordForm.get('newPassword')?.errors?.['minlength']">La contrase√±a debe tener al menos 8 caracteres</div>
                <div *ngIf="changePasswordForm.get('newPassword')?.errors?.['pattern']">La contrase√±a debe contener al menos una may√∫scula, una min√∫scula y un n√∫mero</div>
              </div>
            </div>

            <div class="form-group">
              <label for="confirmPassword">Confirmar nueva contrase√±a</label>
              <div class="password-input">
                <input 
                  [type]="showConfirmPassword ? 'text' : 'password'" 
                  id="confirmPassword"
                  formControlName="confirmNewPassword"
                  placeholder="Confirma tu nueva contrase√±a"
                >
                <!-- <button type="button" class="password-toggle" (click)="togglePasswordVisibility('confirm')">
                  {{ showConfirmPassword ? 'üôà' : 'üëÅÔ∏è' }}
                </button> -->
              </div>
              <div class="error-message" *ngIf="changePasswordForm.get('confirmNewPassword')?.invalid && changePasswordForm.get('confirmNewPassword')?.touched">
                <div *ngIf="changePasswordForm.get('confirmNewPassword')?.errors?.['required']">Confirma tu nueva contrase√±a</div>
              </div>
              <div class="error-message" *ngIf="changePasswordForm.errors?.['passwordMismatch'] && changePasswordForm.touched">
                Las contrase√±as no coinciden
              </div>
            </div>

            <div class="modal-actions">
              <button type="button" class="btn-cancel" (click)="closeChangePasswordModal()">
                Cancelar
              </button>
              <button type="submit" class="btn-save" [disabled]="changePasswordForm.invalid || changingPassword">
                <span *ngIf="changingPassword">Guardando...</span>
                <span *ngIf="!changingPassword">Guardar cambios</span>
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal-overlay" *ngIf="showEditProfileModal" (click)="closeEditProfileModal()">
      <div class="modal-content edit-profile-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Editar perfil</h3>
          <button class="modal-close" (click)="closeEditProfileModal()">&times;</button>
        </div>
        
        <div class="modal-body">
          <p class="modal-description">
            Actualiza tu informaci√≥n de perfil
          </p>

          <!-- Edit Profile Notification -->
          <div *ngIf="showEditProfileMessage" 
               class="modal-notification" 
               [ngClass]="editProfileMessageType === 'error' ? 'submit-error' : 'submit-success'">
            <span>{{ editProfileMessage }}</span>
            <button class="notification-close" (click)="hideEditProfileNotification()">&times;</button>
          </div>
          
          <form [formGroup]="editForm" (ngSubmit)="saveProfile()">
            <!-- Tabs -->
            <div class="profile-tabs">
              <button type="button" 
                      class="tab-button" 
                      [class.active]="activeEditTab === 'username'"
                      (click)="setActiveEditTab('username')">
                Nombre de usuario
              </button>
              <button type="button" 
                      class="tab-button" 
                      [class.active]="activeEditTab === 'avatar'"
                      (click)="setActiveEditTab('avatar')">
                Avatar
              </button>
            </div>

            <!-- Username Tab Content -->
            <div class="tab-content" *ngIf="activeEditTab === 'username'">
              <div class="form-group">
                <label for="username">Nombre de usuario</label>
                <input 
                  type="text" 
                  id="username"
                  formControlName="username"
                  placeholder="Ingresa tu nombre de usuario"
                  class="username-input"
                >
                <div class="error-message" *ngIf="editForm.get('username')?.invalid && editForm.get('username')?.touched">
                  {{ getUsernameErrorMessage() }}
                </div>
              </div>

              <div class="username-requirements">
                <h4>Requisitos del nombre de usuario:</h4>
                <ul>
                  <li>Debe tener entre 3 y 20 caracteres</li>
                  <li>Solo puede contener letras, n√∫meros y guiones bajos</li>
                  <li>No puede contener espacios ni caracteres especiales</li>
                  <li>Debe ser √∫nico</li>
                </ul>
              </div>
            </div>

            <!-- Avatar Tab Content -->
            <div class="tab-content" *ngIf="activeEditTab === 'avatar'">
              <div class="current-avatar-section">
                <h4>Avatar actual</h4>
                <div class="current-avatar-display">
                  <img [src]="getAvatarPath(selectedAvatar) || 'avatar1.png'" alt="Avatar actual" class="current-avatar-image">
                  <p class="avatar-name">{{ getAvatarName(selectedAvatar) }}</p>
                </div>
              </div>

              <div class="avatar-gallery">
                <h4>Selecciona un avatar de la galer√≠a</h4>
                <div class="avatar-grid">
                  <div class="avatar-option" 
                       *ngFor="let avatar of availableAvatars" 
                       [class.selected]="selectedAvatar === avatar.id"
                       (click)="selectAvatar(avatar.id)">
                    <img [src]="avatar.path" [alt]="avatar.name" class="avatar-thumbnail">
                    <div class="avatar-checkmark" *ngIf="selectedAvatar === avatar.id">‚úì</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="modal-actions">
              <button type="button" class="btn-cancel" (click)="closeEditProfileModal()">
                Cancelar
              </button>
              <button type="submit" class="btn-save" [disabled]="editForm.invalid || saving">
                {{ saving ? 'Guardando...' : 'Guardar cambios' }}
              </button>              
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Delete Account Modal -->
    <div class="modal-overlay" *ngIf="showDeleteAccountModal" (click)="closeDeleteAccountModal()">
      <div class="modal-content delete-account-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>Eliminar cuenta</h3>
          <button class="modal-close" (click)="closeDeleteAccountModal()">&times;</button>
        </div>
        
        <div class="modal-body">
          <div class="warning-message">
            <fa-icon [icon]="faExclamationTriangle" class="warning-icon"></fa-icon>
            <p>
              Esta acci√≥n es permanente e irreversible. Se eliminar√°n todos tus datos, escaneos y progreso de aprendizaje.
            </p>
          </div>

          <!-- Delete Account Notification -->
          <div *ngIf="showDeleteAccountMessage" 
               class="modal-notification" 
               [ngClass]="deleteAccountMessageType === 'error' ? 'submit-error' : 'submit-success'">
            <span>{{ deleteAccountMessage }}</span>
            <button class="notification-close" (click)="hideDeleteAccountNotification()">&times;</button>
          </div>
          
          <form [formGroup]="deleteAccountForm" (ngSubmit)="confirmDeleteAccount()">
            <div class="form-group">
              <label for="deletePassword">Ingresa tu contrase√±a para confirmar</label>
              <div class="password-input">
                <input 
                  [type]="showDeletePassword ? 'text' : 'password'" 
                  id="deletePassword"
                  formControlName="password"
                  placeholder="Contrase√±a"
                >
              </div>
              <div class="error-message" *ngIf="deleteAccountForm.get('password')?.invalid && deleteAccountForm.get('password')?.touched">
                La contrase√±a es requerida para eliminar la cuenta
              </div>
            </div>

            <div class="form-group">
              <label class="checkbox-label">
                <input 
                  type="checkbox"
                  formControlName="confirmDelete"
                >
                <span>Confirmo que deseo eliminar mi cuenta permanentemente</span>
              </label>
              <div class="error-message" *ngIf="deleteAccountForm.get('confirmDelete')?.invalid && deleteAccountForm.get('confirmDelete')?.touched">
                Debes confirmar que deseas eliminar tu cuenta
              </div>
            </div>

            <div class="modal-actions">
              <button type="button" class="btn-cancel" (click)="closeDeleteAccountModal()">
                Cancelar
              </button>
              <button type="submit" class="btn-danger" [disabled]="deleteAccountForm.invalid || deletingAccount">
                <span *ngIf="deletingAccount">Eliminando...</span>
                <span *ngIf="!deletingAccount">Eliminar mi cuenta</span>
              </button>              
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
